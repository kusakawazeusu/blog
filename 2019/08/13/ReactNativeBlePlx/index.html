<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149275612-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-149275612-1");
    </script>

    

    <title>ç”¨ react-native-ble-plx ä¾†å’Œ BLE Peripheral äº’å‹• | Kuan and the Elephant</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta name="robots" content="index">

      
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/normalize.css" type="text/css">
    <link rel="stylesheet" href="/css/basscss.css" type="text/css">
    <link rel="stylesheet" href="/css/basscss-ui-groups.css" type="text/css">
    <link rel="stylesheet" href="/css/tomorrow.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    
    <link href="https://rachel.objectstore.co/dist/fonts/lato-v13/lato-v13-all.css" rel="stylesheet" type="text/css">
     

    <!--[if lt IE 9
      ]><script
        src="/js/html5.js"
        type="text/javascript"
      ></script
    ><![endif]-->
    <script src="/js/main.js" type="text/javascript"></script>
  </head>
</html>

<body>
	<section class="container m4 clearfix">
		<div class="clearfix">
			<div class="mb4 sm-flex center nowrap">
	<div class="flex-auto block">
		<a href="/" class="btn button-narrow h2">Kuan and the Elephant</a>
<!--		 | <small class="muted"></small>-->
	</div>
</div>

			<div class="mn1 center menu-list">
	<a target="_blank" href="https://kusakawazeusu.github.io/" class="btn button-narrow">Profile</a>

	
		<a href="/archives/" class="btn button-narrow">Archives</a>
	

	
		<a href="/categories/Movie" class="btn button-narrow">Movie</a>
	
		<a href="/categories/Books" class="btn button-narrow">Books</a>
	
		<a href="/categories/Programming" class="btn button-narrow">Programming</a>
	
		<a href="/categories/Travel" class="btn button-narrow">Travel</a>
	
		<a href="/categories/Book" class="btn button-narrow">Book</a>
	
</div>

			<div class="p0 col col-12">
				<div class="m0 py2">
  <div class="md-col-8 mx-auto">
    <div class="overflow-hidden bg-white rounded">
      <div class="m1 p2 white">
        <div class="clearfix">
          <div class="left">
            <h1 class="h2 m0">
              <a href="/2019/08/13/ReactNativeBlePlx/" class="black">
                ç”¨ react-native-ble-plx ä¾†å’Œ BLE Peripheral äº’å‹•
              </a>
            </h1>
          </div>
          <div class="right">
            <span class="h6 muted black">
              Aug 13 2019
            </span>
          </div>
        </div>
      </div>
      <div class="p2 border-top">
        <img src="/2019/08/13/ReactNativeBlePlx/01.jpeg">

<h2 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h2><p>æœ€è¿‘åœ¨åšä¸€å€‹ BLEï¼ˆä½åŠŸè€—è—ç‰™ï¼‰ çš„ APP æ¡ˆï¼Œå¾é–‹ç™¼å·¥å…·é¸æ“‡ã€ç ”ç©¶åˆ°å¯¦ä½œä¸­é–“èŠ±äº†ä¸€äº›æ™‚é–“ï¼Œä¹Ÿè¸©äº†è¨±å¤šå° BLE çŸ¥è­˜ä¸å¤ æ‰€ç”¢ç”Ÿçš„é›·ã€‚åœ¨é–‹ç™¼ç¬¬ä¸€ç‰ˆæ™‚ï¼Œå°è£ç½®çš„é€£ç·šç¸½æ˜¯ç‰¹åˆ¥æ…¢ï¼Œè€Œä¸”æ‰¾ä¸å‡ºä»€éº¼åŸå› ï¼Œä¸Šäº†å¥½å¤šè¨è«–ç‰ˆç™¼å•ä½†å¾—åˆ°çš„å›ç­”ç”šå°‘ï¼Œæˆ‘ç”šè‡³æ‹‹æ£„ React native è·‘å»æ€’å­¸ Kotlin å¯¦ä½œä¸€å€‹ demoï¼Œä½†ä¹Ÿæ²’è§£æ±ºå•é¡Œï¼Œå¾Œä¾†æ€éº¼è§£æ±ºå‘¢ï¼Ÿæ›äº†ä¸€å€‹è—ç‰™æ™¶ç‰‡å¾Œèµ°è·¯è·Ÿé£›çš„ä¸€æ¨£ï¼Œé€™ä»¶äº‹ä¹Ÿå¤§å¤§åŠ æ·±äº†æˆ‘å°ã€Œç¡¬é«”å¥½å¯æ€•ã€çš„æ—¢å®šå°è±¡ ğŸ˜­ã€‚</p>
<a id="more"></a>

<p>ä»¥ä¸‹é‡å° Android ç‰ˆæœ¬ï¼Œè‹¥ iOS é‚„è¸©ä¸€å †é›·å°±å¯ä»¥å¯«ç¬¬äºŒç¯‡ï¼ˆï¼Ÿï¼‰ã€‚</p>
<hr>
<h2 id="ä½¿ç”¨å¥—ä»¶ï¼šReact-native-ble-plx"><a href="#ä½¿ç”¨å¥—ä»¶ï¼šReact-native-ble-plx" class="headerlink" title="ä½¿ç”¨å¥—ä»¶ï¼šReact-native-ble-plx"></a>ä½¿ç”¨å¥—ä»¶ï¼šReact-native-ble-plx</h2><p><a href="https://polidea.github.io/react-native-ble-plx/" target="_blank" rel="noopener">æ–‡ä»¶</a></p>
<p>é€™å®¶å…¬å¸åŒæ™‚ä¹Ÿæ˜¯ RxAndroidBle çš„é–‹ç™¼è€…ï¼Œç›¸è¼ƒæ–¼å…¶ä»–å¥—ä»¶ï¼ŒBle-plx çš„æ–‡ä»¶å¯«å¾—æ¸…æ¥šè¨±å¤šï¼Œè¨è«–åº¦ä¹Ÿé«˜ï¼Œä¸éæœ‰äº› BLE çš„åŸºç¤çŸ¥è­˜æ‡‰è©²æ˜¯å‡è¨­é–‹ç™¼è€…éƒ½æ‡‚äº†ï¼ˆåƒæ˜¯å¯«å…¥è³‡æ–™çš„ Package å¤§å°é™åˆ¶ï¼‰ï¼Œæ‰€ä»¥å° BLE ä¸€ç„¡æ‰€çŸ¥çš„æˆ‘æ‰è¸©åˆ°ä¸å°‘é›· QQã€‚</p>
<p>å®‰è£ç…§è‘—<a href="https://github.com/Polidea/react-native-ble-plx#android-example-setup" target="_blank" rel="noopener">å®˜æ–¹æ²’å•é¡ŒæŒ‡å—</a>ã€‚</p>
<h2 id="Permissions"><a href="#Permissions" class="headerlink" title="Permissions"></a>Permissions</h2><p>BLE éœ€è¦åœ¨ AndroidManifest.xml é–‹å•Ÿ / è¦æ±‚ä¸‹åˆ—æ¬Šé™ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BLUETOOTH"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ çš„ APP åªæƒ³é–‹æ”¾çµ¦æœ‰ BLE åŠŸèƒ½çš„è£ç½®ä¾†å®‰è£ï¼Œè¦åŠ ä¸Šä¸‹é¢é€™è¡Œï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">"android.hardware.bluetooth_le"</span> <span class="attr">android:required</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="é€£ç·šæµç¨‹"><a href="#é€£ç·šæµç¨‹" class="headerlink" title="é€£ç·šæµç¨‹"></a>é€£ç·šæµç¨‹</h2><p>é€™æ¬¡é–‹ç™¼çš„å°ˆæ¡ˆä¸­ï¼Œæˆ‘ä½¿ç”¨çš„æµç¨‹ç°¡åŒ–å¾Œæœ‰ä¸‹é¢å¹¾å€‹æ­¥é©Ÿï¼š</p>
<ol>
<li>ç¢ºèªè—ç‰™ç‹€æ…‹</li>
<li>ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿ</li>
<li>æœå°‹è£ç½®</li>
<li>èˆ‡è£ç½®é€£ç·š</li>
<li>Discover services and characteristics</li>
<li>è®€å¯«æ“ä½œ</li>
</ol>
<h3 id="Step-1-â€”-ç¢ºèªè—ç‰™ç‹€æ…‹"><a href="#Step-1-â€”-ç¢ºèªè—ç‰™ç‹€æ…‹" class="headerlink" title="Step 1 â€” ç¢ºèªè—ç‰™ç‹€æ…‹"></a>Step 1 â€” ç¢ºèªè—ç‰™ç‹€æ…‹</h3><p>ä¸€é–‹å§‹æˆ‘å€‘å…ˆå¯¦ä¾‹åŒ– <strong>BleManager</strong>ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bleManager = <span class="keyword">new</span> BleManager()</span><br></pre></td></tr></table></figure>

<p>åœ¨å»ºç«‹é€£ç·šä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ä½¿ç”¨è€…å·²ç¶“å°‡è—ç‰™é–‹å•Ÿï¼Œæˆ‘å€‘å¯ä»¥é€é <code>state()</code> ä¾†ç²å–ç›®å‰çš„è—ç‰™ç‹€æ…‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = <span class="keyword">await</span> bleManager.state()</span><br></pre></td></tr></table></figure>

<p>æˆ–æ˜¯ç”¨ subscribe çš„æ–¹å¼ï¼ˆå®˜ç¶²ä¸Šçš„ä¾‹å­ï¼‰ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subscription = <span class="keyword">this</span>.bleManager.onStateChange(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (state === State.PowerOn) &#123;</span><br><span class="line">    <span class="comment">// å·²ç¢ºèªè—ç‰™æ­£å¸¸é–‹å•Ÿ</span></span><br><span class="line">    subscription.remove()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>åªæœ‰ <code>PowerOn</code> æ‰æ˜¯è—ç‰™é–‹å•Ÿä¸”å¯ä½¿ç”¨çš„ç‹€æ…‹ï¼Œè‹¥ä½¿ç”¨è€…çš„è—ç‰™å°šæœªå°±ç·’ï¼Œä½ ä¹Ÿå¯ä»¥å¹«ä»–æ‰“é–‹ï¼ˆAndroid é™å®šï¼‰ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> bleManager.enable()</span><br></pre></td></tr></table></figure>

<h3 id="Step2-â€”-ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿ"><a href="#Step2-â€”-ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿ" class="headerlink" title="Step2 â€” ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿ"></a>Step2 â€” ç¢ºèªæ¬Šé™æ˜¯å¦é–‹å•Ÿ</h3><p>æ¥ä¸‹ä¾†è¦ç¢ºå®š <a href="https://facebook.github.io/react-native/docs/permissionsandroid?source=post_page-----87bbaf495df4----------------------" target="_blank" rel="noopener">ACCESS_COARSE_LOCATION</a> é€™å€‹æ¬Šé™æ˜¯å¦å·²ç¶“è¢«æˆæ¬Šï¼Œé€™å€‹æœ‰é»é›¢é¡Œå°±ä¸åœ¨é€™è£¡è©³è¿°äº†ï¼Œåªæ˜¯æ²’æœ‰æ‰“é–‹é€™å€‹æ¬Šé™æœƒç„¡æ³•é€²è¡Œ Scanã€‚ï¼ˆè¸©åˆ°çš„ç¬¬ä¸€å€‹é›·ï¼‰</p>
<h3 id="Step3-â€”-æœå°‹è£ç½®"><a href="#Step3-â€”-æœå°‹è£ç½®" class="headerlink" title="Step3 â€” æœå°‹è£ç½®"></a>Step3 â€” æœå°‹è£ç½®</h3><p>æˆ‘å€‘é€šå¸¸æœƒé€é è£ç½®çš„åç¨± ï¼Œæˆ–æ˜¯ UUID ä¾†æ‰¾åˆ°æˆ‘å€‘è¦é€£ç·šçš„è£ç½®ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bleManager.startDeviceScan(UUIDs, ScanOptions, Listener)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>UUIDs (Array of UUID)</strong><br>é€™æ˜¯åœ¨æœå°‹æ™‚æœƒä½¿ç”¨çš„ filter ï¼Œå¦‚æœå‚³å…¥ null ï¼Œå‰‡æ¯ç™¼ç¾ä¸€å€‹ä»»ä½•è£ç½®ï¼Œä»–å°±æœƒ call Listener ä¸€æ¬¡ï¼Œè‹¥ä½ å·²ç¶“çŸ¥é“ä½ è£ç½®çš„ UUID ï¼Œå¯ä»¥ç›´æ¥åœ¨é€™è£¡éæ¿¾ï¼Œå°±ä¸ç”¨åœ¨ Listener å¤šåšä¸€å±¤æª¢æŸ¥ã€‚</li>
</ul>
<ul>
<li><strong>ScanOptions (Object)</strong><br>é€™è£¡æœ‰ä¸€å€‹é‡è¦çš„åƒæ•¸å«ä½œ ScanModeï¼Œä»–æ§åˆ¶äº†æœå°‹è£ç½®çš„ duty cycleï¼š<ul>
<li>LowPowerï¼šæœ€ç¯€èƒ½ä¹Ÿæœ€æ…¢ï¼ˆé è¨­ï¼‰</li>
<li>Balancedï¼šè€—èƒ½èˆ‡é€Ÿåº¦ä»‹æ–¼å…©è€…ä¹‹é–“</li>
<li>LowLatencyï¼šæœ€è€—èƒ½ä¹Ÿæœ€å¿«</li>
</ul>
</li>
</ul>
<p>é‚„æœ‰æ¯”è¼ƒç‰¹åˆ¥çš„æ¨¡å¼ï¼š Opportunisticï¼ŒæŠ•æ©Ÿä»”ï¼Œä½¿ç”¨çš„è©±é€™å€‹ APP æœ¬èº«ä¸æœƒé€²è¡Œæœå°‹ï¼Œè€Œæ˜¯æœƒä½¿ç”¨å…¶ä»– APP çš„æƒæçµæœï¼Œåƒæ˜¯æˆ‘é–‹è‘—æˆ‘çš„ APP ï¼Œç„¶å¾Œå¦å¤–æ‰“é–‹ Ble Tool ä¾†é€²è¡Œæœå°‹ï¼ŒBle Tool æ‰¾åˆ°è£ç½®å¾Œæˆ‘çš„ APP å°±å¯ä»¥æŠŠçµæœæ’¿å»ç”¨ã€‚</p>
<ul>
<li><strong>Listener (Function)</strong><br>ä½ çš„ callback functionï¼Œè‹¥ä½ ä½¿ç”¨åå­—ä¾†æœå°‹è£ç½®çš„è©±ï¼Œå°±åƒä¸‹é¢çš„ç¨‹å¼ï¼š</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bleManager.startDeviceScan(<span class="literal">null</span>, &#123; <span class="attr">scanMode</span>: ScanMode.LowLatency &#125;, (error, device) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (device.name !== <span class="string">"DeviceName"</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  bleManager.stopDeviceScan()</span><br><span class="line">  <span class="comment">// åœ¨é€™è£¡å° device é€²è¡Œæ“ä½œ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Step-4â€”-èˆ‡è£ç½®é€£ç·š"><a href="#Step-4â€”-èˆ‡è£ç½®é€£ç·š" class="headerlink" title="Step 4â€” èˆ‡è£ç½®é€£ç·š"></a>Step 4â€” èˆ‡è£ç½®é€£ç·š</h3><p>ç•¶ä½ æœå°‹åˆ°è£ç½®ï¼Œå°±å¯ä»¥é¦¬ä¸Šèˆ‡è£ç½®é€²è¡Œé€£ç·šï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> device.connect()</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error.reason)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£æˆ‘å¯ä¸å¯ä»¥è·³éæœå°‹è£ç½®é€™å€‹æ­¥é©Ÿï¼Œç›´æ¥é€²è¡Œé€£ç·šå‘¢ï¼Ÿå¯ä»¥å“‡ï¼Œå¦‚æœä½ çŸ¥é“è£ç½®çš„ UUIDï¼Œä½ æ˜¯å¯ä»¥ç›´æ¥é€²è¡Œé€£ç·šçš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> bleManager.connectToDevice(UUID, &#123; <span class="attr">timeout</span>: <span class="number">2000</span> &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(error.reason)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>connect() å’Œ connectToDevice() éƒ½æœƒæ¥æ”¶ä¸€å€‹ ConnectionOptions çš„åƒæ•¸ï¼Œç”¨ä¾†è¨­å®šé€£ç·šï¼š</p>
<ul>
<li><strong>refreshGatt (Boolean)</strong><br>è¨­å®š true çš„è©±ï¼Œé€£ç·šæ™‚æœƒæ¸…é™¤ service cache ï¼Œå¦‚æœä½ çš„éŸŒé«”æœ‰æ›´æ–°ï¼Œå°è‡´ services / characteristics ç¶“éä¿®æ”¹çš„è©±ï¼Œå®ƒå¯ä»¥é˜²æ­¢ä½ ä½¿ç”¨åˆ°èˆŠç‰ˆçš„ cacheã€‚</li>
</ul>
<ul>
<li><strong>timeout (Number)</strong><br>å–®ä½æ˜¯ msï¼Œå¦‚æœä½ æ˜¯ç›´æ¥é€£ç·šä¸ç¶“éæœå°‹çš„è©±ï¼Œé€™å€‹ç‰¹åˆ¥å¥½ç”¨ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œä½ å¯ä»¥å…ˆé€²è¡Œç›´æ¥é€£ç·šï¼Œ timeout äº†å†é–‹å§‹æœå°‹è£ç½®ã€‚</li>
</ul>
<ul>
<li><strong>requestMTU (Number)</strong><br>MTU æ˜¯ <code>Maximum Transmission Unit</code>ï¼Œæœ€å¤§å‚³è¼¸å–®å…ƒï¼Œä»£è¡¨ä½ ä¸€æ¬¡ Write ä¸€åŒ…çš„ package å¯ä»¥æœ‰å¹¾å€‹ bytesï¼Œä½†é€™è¦çœ‹è—ç‰™è£ç½®æ˜¯å¦å¯ä»¥èª¿æ•´ MTUã€‚</li>
</ul>
<ul>
<li><strong>autoConnect (Boolean)</strong><br>è‹¥è¨­ç‚º falseï¼ˆé è¨­ï¼‰ï¼Œå‰‡æœƒç›´æ¥é€²è¡Œé€£ç·šï¼Œè¨­ç‚º true æœƒç­‰è£ç½® ready æ‰é€²è¡Œé€£ç·šã€‚</li>
</ul>
<h3 id="Step5-â€”-Discover-services"><a href="#Step5-â€”-Discover-services" class="headerlink" title="Step5 â€” Discover services"></a>Step5 â€” Discover services</h3><p>é€£ç·šå®Œä¹‹å¾Œï¼Œä½ å¿…é ˆè¦ discover è£ç½®ä¸Šæ‰€æœ‰çš„ services å’Œ characteristics æ‰å¯ä»¥é€²è¡Œè®€å¯«ï¼Œè—ç‰™è£ç½®è£¡æœƒæœ‰è¨±å¤šçš„ services ï¼Œåƒæ˜¯ç³»çµ±é›»é‡ Serviceï¼Œæˆ–æ˜¯ç³»çµ±è³‡è¨Š Serviceï¼Œè€Œæ¯ä¸€å€‹ Service åº•ä¸‹æœƒæœ‰è¨±å¤š characteristics ï¼ˆç‰¹å¾µï¼‰ï¼Œé€™æ‰æ˜¯æˆ‘å€‘è¦è®€å¯«è³‡æ–™çš„ç›®æ¨™ã€‚</p>
<p>æ¯ä¸€å€‹ Service å’Œ Characteristic éƒ½æœ‰è‡ªå·±çš„ UUIDï¼Œåœ¨ä½ è®€å¯«å‰ä½ è¦çŸ¥é“ä½ è©²å° å“ªä¸€å€‹ Service è£¡é¢çš„ å“ªä¸€å€‹ Characteristic é€²è¡Œæ“ä½œã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> device.discoverAllServicesAndCharacteristics()</span><br></pre></td></tr></table></figure>

<h3 id="Step6-â€”-è®€å¯«æ“ä½œ"><a href="#Step6-â€”-è®€å¯«æ“ä½œ" class="headerlink" title="Step6 â€” è®€å¯«æ“ä½œ"></a>Step6 â€” è®€å¯«æ“ä½œ</h3><h4 id="å¯«é€²å»"><a href="#å¯«é€²å»" class="headerlink" title="å¯«é€²å»"></a>å¯«é€²å»</h4><p>è®€å¯«çš„æ“ä½œç›®æ¨™æ˜¯ Characteristic ï¼ˆç‰¹å¾µï¼‰ï¼Œåœ¨ Ble-plx ä¸­ï¼Œä¸€å€‹ characteristic ç‰©ä»¶é•·å¾—åƒä¸‹é¢é€™æ¨£ï¼š</p>
<img src="/2019/08/13/ReactNativeBlePlx/02.png">

<p>åœ¨ BLE å‚³è¼¸æ™‚ï¼Œæœƒæœ‰ MTU ï¼ˆæœ€å¤§å‚³è¼¸å–®å…ƒï¼‰çš„é™åˆ¶ï¼Œä»–ä»£è¡¨ä½ ä¸€æ¬¡åªèƒ½è®€å¯«å¤šå°‘ bytes çš„è³‡æ–™ï¼Œé è¨­å€¼æ˜¯ 23 bytes ï¼ˆä½†æ‰£æ‰ 3 bytes çš„ headerï¼Œä½ ä¸€æ¬¡åªèƒ½å‚³ 20 bytesï¼ï¼‰ï¼Œé€™æ™‚å€™æœ‰å…©å€‹æ–¹æ³•å¯ä»¥è§£æ±ºï¼š</p>
<ul>
<li><strong>requestMTU</strong><br>è·Ÿè£ç½®å”èª¿ä½ å€‘ä¹‹é–“æºé€šçš„ MTUï¼Œä½†é€™å¾—çœ‹è©²è£ç½®æ˜¯å¦æœ‰æä¾›é€™å€‹åŠŸèƒ½ã€‚</li>
</ul>
<ul>
<li><strong>å‚³ä¸€æ¬¡ä¸å¤ ï¼Œä½ æœ‰å‚³å¾ˆå¤šæ¬¡å—ï¼Ÿ</strong><br>ä¾‹å¦‚èªªæˆ‘ä¸€æ¬¡è¦å¯« 25 bytes çš„è³‡æ–™ï¼Œé‚£æˆ‘å°±åˆ†æˆ 20 è·Ÿ 5 bytes ä¾†å‚³ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯é€™å€‹æ–¹å¼ï¼Œå› ç‚ºâ‹¯â‹¯æˆ‘çš„è£ç½®ä¸çµ¦æˆ‘æ”¹ MTU â•°(ã€’çš¿ã€’)â•¯ã€‚</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> device.writeCharacteristicWithResponse(</span><br><span class="line">  Service_UUID,</span><br><span class="line">  Characteristic_UUID,</span><br><span class="line">  Data</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œä½ å‚³çš„ data å¿…é ˆæ˜¯ç¶“é base64 encode ä¹‹å¾Œçš„å­—ä¸²ï¼Œåœ¨é€™è£¡æˆ‘æ¨è–¦ä½¿ç”¨ JavaScript çš„ Buffer ä¾†é€²è¡Œè™•ç†ï¼Œå‡è¨­æˆ‘è¦å‚³ã€ŒPASSã€å››å€‹å­—å…ƒï¼Œå¯ä»¥é€™æ¨£è™•ç†ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> byteArray = (<span class="string">"PASS"</span>).split(<span class="string">""</span>).map(<span class="function"><span class="params">char</span> =&gt;</span> char.charCodeAt(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> device.writeCharacteristicWithResponse(</span><br><span class="line">  Service_UUID,</span><br><span class="line">  Characteristic_UUID,</span><br><span class="line">  Buffer.from(byteArray).toString(<span class="string">"base64"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>æœƒé¸ç”¨ Buffer ï¼Œé™¤äº†å®ƒ encode base64 å¾ˆæ–¹ä¾¿ä¹‹å¤–ï¼Œè¦é€²è¡Œåˆ‡å‰²ä¹Ÿå¯ä»¥ç›´æ¥ç”¨å…§å»ºçš„ slice ä¾†é€²è¡Œï¼Œç›¸ç•¶é©åˆé€™å€‹æƒ…å¢ƒï¼</p>
<h4 id="è®€å‡ºä¾†"><a href="#è®€å‡ºä¾†" class="headerlink" title="è®€å‡ºä¾†"></a>è®€å‡ºä¾†</h4><p>ç›¸è¼ƒæ–¼å¯«å…¥ï¼Œè®€è³‡æ–™å°±ç›¸å°å–®ç´”ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; value &#125; = <span class="keyword">await</span> bleManager.readCharacteristicForDevice(</span><br><span class="line">  Device_UUID,</span><br><span class="line">  Service_UUID,</span><br><span class="line">  Characteristic_UUID</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(atob(value))</span><br></pre></td></tr></table></figure>

<p>è‹¥ä½ è¦è¿½è¹¤ä¸€å€‹ Characteristic çš„æ•¸å€¼ï¼Œæƒ³è¦çŸ¥é“ä»–ä»€éº¼æ™‚å€™æ”¹è®Šçš„è©±ï¼Œä¹Ÿæœ‰å°æ‡‰çš„ function å¯ä»¥ç”¨ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subscription = device.monitorCharacteristicForService(</span><br><span class="line">  Service_UUID,</span><br><span class="line">  Characteristic_UUID,</span><br><span class="line">  (error, characteristic) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(characteristic.value)</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æ¸¬è©¦å·¥å…·"><a href="#æ¸¬è©¦å·¥å…·" class="headerlink" title="æ¸¬è©¦å·¥å…·"></a>æ¸¬è©¦å·¥å…·</h2><p>æ¨è–¦ä½¿ç”¨ Android ä¸Šçš„ <a href="https://play.google.com/store/apps/details?id=com.cozyoz.bletool&hl=zh_TW" target="_blank" rel="noopener">BLE Tool</a>ï¼Œå¯ä»¥é€²è¡Œè®€å¯«ï¼Œä»‹é¢ç›¸å°åœ°å¥½ç”¨ã€‚</p>
<hr>
<h2 id="ç–‘é›£é›œç—‡ç³»åˆ—"><a href="#ç–‘é›£é›œç—‡ç³»åˆ—" class="headerlink" title="ç–‘é›£é›œç—‡ç³»åˆ—"></a>ç–‘é›£é›œç—‡ç³»åˆ—</h2><ul>
<li><strong>ç‹€æ…‹å¤ªå¤šé›£ä»¥ç®¡ç†</strong><br>ä¸Šè¿°çš„é€£ç·šæµç¨‹æ˜¯åŸºæœ¬çš„è³‡æ–™è®€å¯«ï¼Œåœ¨ä¸€èˆ¬çš„æ¡ˆä¾‹ä¸­å¿…å®šæœ‰é¡å¤–çš„æµç¨‹ï¼Œå¦‚å¾ AsyncStorage æ’ˆè³‡æ–™å•¦ã€å†æ¬¡ç¢ºèªé€£ç·šç‹€æ…‹ç­‰ç­‰â‹¯â‹¯<br>è€Œä¸”é€™äº›éƒ½æ˜¯éåŒæ­¥æ“ä½œæ¬¸ï¼Œè®“äººå¾ˆé ­ç—›ï¼Œä¸€ä¸å°å¿ƒåˆé€²å…¥ await åœ°ç„ï¼Œæˆ‘ç¬¬äºŒç‰ˆæ”¹ç”¨ redux-saga ä¾†æ”¹å¯«é€£ç·šçš„æµç¨‹ï¼ŒCode è®Šå¾—ä¹¾æ·¨è¨±å¤šåˆå¾ˆçˆ½ï¼Œå¯«æ¸¬è©¦ä¹Ÿè®Šå¾—è¼•è¼•é¬†é¬†ï¼ï¼ˆå¦‚æœä½ è¦å¯«æ¸¬è©¦çš„è©±ï¼‰ã€‚<br>å°¤å…¶æ˜¯ take / put å¼çš„å¯«æ³•å¯«èµ·ä¾†è·ŸåŒæ­¥ Code ä¸€æ¨£ç›´è¦ºï¼Œå¯ä»¥åƒè€ƒé€™ä»½æ–‡ä»¶ã€‚</li>
</ul>
<ul>
<li><strong>æœå°‹è£ç½®å¾ˆæ…¢ / æœå°‹ä¸åˆ°è£ç½®</strong><br>é€šå¸¸æˆ‘æœƒå…ˆç”¨ BLE Tool æª¢æŸ¥ï¼Œè‹¥ BLE Tool æ­£å¸¸ï¼Œå¯ä»¥æª¢æŸ¥ä½ çš„ APP æ˜¯å¦æœ‰æ­£ç¢ºæˆæ¬Š ACCESS_COARSE_LOCATIONï¼ŒBLE Tool ä¹Ÿæ‰¾ä¸åˆ°çš„è©±â‹¯â‹¯å¯ä»¥æ›é¡†è£ç½®çœ‹çœ‹ã€‚<br>æœå°‹å¾ˆæ…¢çš„è©±ï¼Œå°‡ ScanMode æ”¹æˆ LowLatency é€Ÿåº¦æœƒå¤§å¹…æå‡ã€‚</li>
</ul>
<ul>
<li><strong>æœå°‹è£ç½®æ™‚å¿«æ™‚æ…¢</strong><br>ä¸€èˆ¬çš„ BLE Peripheral åŒæ™‚åªèƒ½èˆ‡ä¸€å€‹ Application é€£ç·šï¼Œå¦‚æœå®ƒæ­£åœ¨èˆ‡å…¶ä»–è£ç½®è™•æ–¼é€£æ¥çš„ç‹€æ…‹ï¼Œå‰‡å¤§å®¶éƒ½æœƒæœå°‹ä¸åˆ°å®ƒï¼Œä½ å¯ä»¥ç¢ºèªä¸€ä¸‹ä½ çš„ APP æ˜¯å¦åœ¨æ“ä½œçµæŸå¾Œæœ‰å¥½å¥½çš„è·Ÿä»–æ–·ç·šï¼Œå¦‚æœé‚„æ˜¯æ™‚å¥½æ™‚å£ï¼Œé‚£â‹¯â‹¯å¯ä»¥æ›é¡†è£ç½®çœ‹çœ‹ã€‚</li>
</ul>
<ul>
<li><strong>åœ¨é€£ç·šå‰ï¼Œè«‹è¨˜å¾—è¦å…ˆ stopDeviceScanï¼Œåœ¨ Android ç³»çµ±ä¸­æœ‰å¯èƒ½å‡º Bug</strong><br>ä»¥ä¸Šæ˜¯èˆ‡ BLE è£ç½®é€£ç·šæ“ä½œçš„ä¸€äº›å°å¿ƒå¾—ï¼Œè‹¥æœ‰ä»»ä½•éŒ¯èª¤æˆ–ç–‘æƒ‘çš„éƒ¨åˆ†ï¼Œæ­¡è¿ç•™è¨€è¨è«–ã€‚</li>
</ul>

      </div>
      <hr />
      <div class="p2">
        <h3 class="h3">å–œæ­¡é€™ç¯‡æ–‡ç« å—ï¼Ÿ</h3>
        <p>æ­¡è¿é»æ“ŠæŒ‰éˆ•åˆ†äº«åˆ° Facebook ä¸Šå”·ï¼</p>
        <div class="fb-share-button" data-href="/2019/08/13/ReactNativeBlePlx/" data-layout="button" size="large"></div>
      </div>

      <div class="p2 border-top">
        <div class="clearfix">
          <div class="left">
            
          </div>
          <div class="ml2 right">
            <span class="h6 muted black">
              
              <a class="link" href="/categories/Programming/">Programming</a> 
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--  DISQUS	-->
  
  <div class="md-col-10 mx-auto mt2">
    <div class="overflow-hidden bg-white rounded">
      <div class="m1 p2 white">
        <div id="disqus_thread"></div>
        <script>
          var disqus_shortname = 'kuan-and-the-elephant'
          ;(function() {
            // DON'T EDIT BELOW THIS LINE
            var d = document,
              s = d.createElement('script')

            s.src = '//' + disqus_shortname + '.disqus.com/embed.js'

            s.setAttribute('data-timestamp', +new Date())
            ;(d.head || d.body).appendChild(s)
          })()
        </script>
        <noscript
          >Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript
        >
      </div>
    </div>
  </div>
   
  <div class="clearfix mt2">
    
    <a href="/2019/09/27/TypeScriptExpress01/" class="left btn">
      <svg class="icon" data-icon="chevron-left"></svg>
      prev: ç”¨ TypeScript å¯« express â€” Route èˆ‡ Controller ç¯‡
    </a>
     
    <a href="/2019/04/17/LaravelEncryption/" class="right btn">
      next: Laravel Encryption å’Œä¸€äº›å¯†ç¢¼å­¸ç­†è¨˜
      <svg class="icon" data-icon="chevron-right"></svg>
    </a>
    
  </div>
  

  <!--  FACEBOOK PLUGIN	-->
  <div id="fb-root"></div>
  <script>
    ;(function(d, s, id) {
      var js,
        fjs = d.getElementsByTagName(s)[0]
      if (d.getElementById(id)) return
      js = d.createElement(s)
      js.id = id
      js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0'
      fjs.parentNode.insertBefore(js, fjs)
    })(document, 'script', 'facebook-jssdk')
  </script>
</div>


			</div>
		</div>
	</section>
	<div class="container mb2 clearfix">
	<div class="sm-flex center nowrap mb2 h5">
		<div class="flex-auto border-bottom">
			<a href="https://hexo.io/" class="btn block muted">Hexo</a>
		</div>
		<div class="flex-auto border-bottom">
			<a href="https://zllovesuki.git.sx/essays/2016/02/hexo-theme-weightless/" class="btn block">Weightless</a> Theme
		</div>
		<div class="flex-auto border-bottom">
			Rocking <a href="http://www.basscss.com/" class="btn block">Basscss</a>
		</div>
		<div class="flex-auto border-bottom">
			
		</div>
	</div>
</div>
<script src="/js/geomicons.js"></script>
<script type="text/javascript">
	var icons = document.querySelectorAll('[data-icon]');
	geomicons.inject(icons);
</script>




</body>
</html>
